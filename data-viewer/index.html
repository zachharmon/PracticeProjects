<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">

    <style>
        #loading-blind{
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #loading-spinner{
            position: relative;
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="view-monitors" onclick="toggleModal('monitors')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>database-eye-outline</title><path d="M9.1 19.7L8.8 19L9 18.6C7.1 18.1 6 17.3 6 17V14.8C7.3 15.4 8.8 15.8 10.6 16C11.3 15.2 12.2 14.5 13.1 14H12C9.6 14 7.3 13.4 6 12.5V9.6C7.5 10.4 9.6 11 12 11S16.5 10.5 18 9.6V12.4C17.7 12.6 17.4 12.8 17 13C18 13 19 13.2 20 13.6V7C20 4.8 16.4 3 12 3S4 4.8 4 7V17C4 18.8 6.4 20.3 9.7 20.8C9.5 20.5 9.3 20.1 9.1 19.7M12 5C15.9 5 18 6.5 18 7S15.9 9 12 9 6 7.5 6 7 8.1 5 12 5M17 18C17.6 18 18 18.4 18 19S17.6 20 17 20 16 19.6 16 19 16.4 18 17 18M17 15C14.3 15 11.9 16.7 11 19C11.9 21.3 14.3 23 17 23S22.1 21.3 23 19C22.1 16.7 19.7 15 17 15M17 21.5C15.6 21.5 14.5 20.4 14.5 19S15.6 16.5 17 16.5 19.5 17.6 19.5 19 18.4 21.5 17 21.5Z" /></svg>
    </div>

    <h1>Web Data Monitor</h1>
    <p>
        This is a simple web data monitor that allows you to monitor data from a URL in HTML, JSON, or XML format. <br>
        You can enter a URL and select the format of the data you want to monitor. <br>
        If the data is in HTML format, you can select the data you want to monitor by entering a CSS selector. <br>
        If the data is in JSON or XML format, you can step into the data by entering the key you want to step into. <br>
        By clicking the "Monitor Data" button, you can save the data you want to monitor and receive alerts when that data changes. <br>
    </p>

    <div id="query">

        <div class="input-area">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Email to notify">
        </div>

        <div class="input-area">
            <label for="url">URL</label>
            <input type="text" id="url" placeholder="URL">
        </div>
        <div class="radio-area">
            <div class="radio-section">
                <label for="html">HTML</label>
                <input type="radio" name="format" value="html" id="html" checked>
            </div>
            <div class="radio-section">
                <label for="json">JSON</label>
                <input type="radio" name="format" value="json" id="json">
            </div>
            <div class="radio-section">
                <label for="xml">XML</label>
                <input type="radio" name="format" value="xml" id="xml">
            </div>
        </div>
        <button id="submit">Submit</button>
    </div>

    <div id="result" class="hidden">

    </div>

    <div id="loading-blind">
        <div id="loading-spinner"></div>
    </div>

    <div class="modal" id="monitors">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Monitors</h2>
                <span class="close" onclick="toggleModal('monitors')">&times;</span>
            </div>
            <div class="modal-body">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th>URL</th>
                            <th>Type</th>
                            <th>Key Steps</th>
                            <th>Email</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>      
        </div>
    </div>
    

    <script>

        document.addEventListener('DOMContentLoaded', () => {
            fetch(`http://127.0.0.1:5000/monitors`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                data.forEach((monitor, index) => {
                    let row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${monitor[0]}</td>
                        <td>${monitor[1]}</td>
                        <td>${monitor[2]}</td>
                        <td>${monitor[3].replace("[", "").replace("]", "").split(',').join(', ')}</td>
                        <td>${monitor[4]}</td>
                        <td><button class="delete-button" data-id="${monitor[0]}" onclick="deleteMonitor(${monitor[0]})">Delete</button></td>
                    `;
                    document.querySelector('#monitors tbody').appendChild(row);
                });
            })
            .catch(err => {
                console.error(err);
            });
        });

        function deleteMonitor(id){

            let conf = confirm('Are you sure you want to delete this monitor?');

            if(!conf){
                return;
            }

            fetch(`http://127.0.0.1:5000/monitors/remove/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                alert('Monitor deleted');
                location.reload();
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting monitor. Please try again.');
            });
        }

        document.getElementById('monitors').addEventListener('click', (e) => {
            // If the click is outside the modal content, close the modal
            if (e.target.id === 'monitors') {
                toggleModal('monitors', false);
            }
        });

        const url = document.getElementById('url');
        const html = document.getElementById('html');
        const json = document.getElementById('json');
        const xml = document.getElementById('xml');
        const submit = document.getElementById('submit');
        const result = document.getElementById('result');

        var FETCHED_URL = null;
        var FETCHED_TYPE = null;
        var FETCHED_DATA = null;
        var ORIGINAL_DATA = null;
        var STEPS = [];

        submit.addEventListener('click', () => {

            toggleLoading(true);

            let format = '';
            if (html.checked) {
                format = 'html';
            } else if (json.checked) {
                format = 'json';
            } else if (xml.checked) {
                format = 'xml';
            }

            if(url.value == '') {
                alert('Please enter a URL');
                toggleLoading(false);
                return;
            }

            if(format == '') {
                alert('Please select a format');
                toggleLoading(false);
                return;
            }

            STEPS = [];

            // Clear the result area
            result.innerHTML = '';

            document.getElementById("save-button")?.remove();

            FETCHED_URL = url.value;
            FETCHED_TYPE = format;

            // If the type is HTML, display a preview of the page in an iframe and an interactive selector to choose the data to extract.
            if (format === 'html') {
                fetch(`http://127.0.0.1:5000/html`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: url.value
                })
                .then(response => response.text())
                .then(data => {
                    ORIGINAL_DATA = data;
                    FETCHED_DATA = data;
                    let html_div = document.createElement('div');
                    html_div.innerHTML = "<h4>Resulting HTML:</h4>";
                    html_div.id = 'html-div';
                    result.appendChild(html_div);

                    let container = document.createElement('div');

                    let html_preview = document.createElement('iframe');
                    html_preview.srcdoc = data;
                    html_preview.id = 'html-preview';
                    container.appendChild(html_preview);
                    
                    let html_string_view = document.createElement('div');
                    html_string_view.innerHTML = `<pre>${formatHTMLString(data)}</pre>`;
                    html_string_view.id = 'html-string-view';
                    container.appendChild(html_string_view);

                    html_div.appendChild(container);

                    let selector_input = document.createElement('input');
                    selector_input.type = 'text';
                    selector_input.placeholder = 'Enter a CSS selector';
                    selector_input.id = 'selector-input';
                    result.appendChild(selector_input);

                    selector_input.addEventListener('input', () => {
                        // Highlight the selected data
                        let selected_data = html_preview.contentDocument.querySelector(selector_input.value);
                        if (selected_data) {
                            html_preview.contentDocument.querySelectorAll('.custom-selected-102984328').forEach(e => e.remove());

                            let hightlight_box_html = `
                                <div class="custom-selected-102984328" 
                                    style="width: ${selected_data.offsetWidth}px; height: ${selected_data.offsetHeight}px; top: calc(${selected_data.top}px - ${selected_data.offsetHeight}px); left: calc(${selected_data.left}px); position: absolute; background-color: rgba(0, 255, 0, 0.6); border: 1px solid green; z-index: 1000;"
                                ></div>
                            `
                            
                            html_preview.contentDocument.querySelector(selector_input.value).insertAdjacentHTML('beforebegin', hightlight_box_html);
                        }
                        else{
                            html_preview.contentDocument.querySelectorAll('.custom-selected-102984328').forEach(e => e.remove());
                        }
                    });

                    result.classList.remove('hidden');

                    var save_button = document.createElement('button');
                    save_button.innerHTML = 'Monitor Data';
                    save_button.id = 'save-button';
                    result.parentElement.appendChild(save_button);

                    save_button.addEventListener('click', submitMonitor);

                    toggleLoading(false);
                })
                .catch(err => {
                    console.error(err);
                    alert('Error fetching data. Please try again.');
                    toggleLoading(false);
                });
            } 
            // If the type is JSON, display the JSON data in a formatted way.
            else if (format === 'json') {
                fetch(`http://127.0.0.1:5000/json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: url.value
                })
                .then(response => response.json())
                .then(data => {
                    ORIGINAL_DATA = data;
                    FETCHED_DATA = data;
                    let json_div = document.createElement('div');
                    json_div.innerHTML = "<h4>Resulting JSON:</h4>" + `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    json_div.id = 'json-div';
                    result.appendChild(json_div);

                    let step_input = document.createElement('input');
                    step_input.type = 'text';
                    step_input.placeholder = 'Enter a key to step into';
                    step_input.id = 'step-input';
                    result.appendChild(step_input);

                    let step_button = document.createElement('button');
                    step_button.innerHTML = 'Step';
                    step_button.id = 'step-button';
                    result.appendChild(step_button);

                    step_button.addEventListener('click', () => {
                        try{
                            let new_json = JSON.parse(JSON.stringify(FETCHED_DATA[step_input.value]));
                            FETCHED_DATA = new_json;
                        }
                        catch(e){
                            alert('Invalid key');
                            return;
                        }

                        let json_div = document.getElementById('json-div');
                        json_div.innerHTML = "<h4>Resulting JSON:</h4>" + `<pre>${JSON.stringify(FETCHED_DATA, null, 2)}</pre>`;

                        STEPS.push(step_input.value);
                    });

                    let reset_button = document.createElement('button');
                    reset_button.innerHTML = 'Reset';
                    reset_button.id = 'reset-button';
                    result.appendChild(reset_button);

                    reset_button.addEventListener('click', () => {
                        FETCHED_DATA = JSON.parse(JSON.stringify(ORIGINAL_DATA));
                        let json_div = document.getElementById('json-div');
                        json_div.innerHTML = "<h4>Resulting JSON:</h4>" + `<pre>${JSON.stringify(FETCHED_DATA, null, 2)}</pre>`;
                        STEPS = [];
                    });

                    result.classList.remove('hidden');

                    var save_button = document.createElement('button');
                    save_button.innerHTML = 'Monitor Data';
                    save_button.id = 'save-button';
                    result.parentElement.appendChild(save_button);

                    save_button.addEventListener('click', submitMonitor);

                    toggleLoading(false);
                })
                .catch(err => {
                    console.error(err);
                    alert('Error fetching data. Please try again.');
                    toggleLoading(false);
                });
            }
            // If the type is XML, display the XML data in a formatted way.
            else if (format === 'xml') {
                fetch(`http://127.0.0.1:5000/xml`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: url.value
                })
                .then(response => response.text())
                .then(data => {

                    //remove the xml declaration
                    data = data.replace(/<\?xml.*\?>/, '');

                    ORIGINAL_DATA = data;
                    FETCHED_DATA = data;
                    let xml_div = document.createElement('div');
                    xml_div.innerHTML = "<h4>Resulting XML:</h4>" + `<pre>${formatHTMLString(data)}</pre>`;
                    xml_div.id = 'xml-div';
                    result.appendChild(xml_div);

                    let step_input = document.createElement('input');
                    step_input.type = 'text';
                    step_input.placeholder = 'Enter a key to step into';
                    step_input.id = 'step-input';
                    result.appendChild(step_input);

                    let step_button = document.createElement('button');
                    step_button.innerHTML = 'Step';
                    step_button.id = 'step-button';
                    result.appendChild(step_button);

                    step_button.addEventListener('click', () => {
                        try{
                            let parser = new DOMParser();
                            let xml = parser.parseFromString("<temp>" + FETCHED_DATA + "</temp>", 'text/xml');
                            let new_json = xmlToJson(xml)['temp'];

                            console.log(new_json);

                            new_json = new_json[step_input.value];

                            if(new_json === undefined){
                                alert('Invalid key');
                                return;
                            }

                            FETCHED_DATA = jsonToXml(new_json);
                        }
                        catch(e){
                            console.log(e);
                            alert('Invalid key');
                            return;
                        }

                        let xml_div = document.getElementById('xml-div');
                        xml_div.innerHTML = "<h4>Resulting XML:</h4>" + `<pre>${formatHTMLString(FETCHED_DATA)}</pre>`;

                        STEPS.push(step_input.value);
                    });

                    let reset_button = document.createElement('button');
                    reset_button.innerHTML = 'Reset';
                    reset_button.id = 'reset-button';
                    result.appendChild(reset_button);

                    reset_button.addEventListener('click', () => {
                        FETCHED_DATA = ORIGINAL_DATA;
                        let xml_div = document.getElementById('xml-div');
                        xml_div.innerHTML = "<h4>Resulting XML:</h4>" + `<pre>${formatHTMLString(FETCHED_DATA)}</pre>`;
                        STEPS = [];
                    });

                    result.classList.remove('hidden');

                    var save_button = document.createElement('button');
                    save_button.innerHTML = 'Monitor Data';
                    save_button.id = 'save-button';
                    result.parentElement.appendChild(save_button);

                    save_button.addEventListener('click', submitMonitor);

                    toggleLoading(false);
                })
                .catch(err => {
                    console.error(err);
                    alert('Error fetching data. Please try again.');
                    toggleLoading(false);
                });
            }
                
        });

        // Format the HTML string to display it in a pre tag. Also add the proper indentation.
        function formatHTMLString(html_string){

            let temp_node = document.createElement('div');
            temp_node.innerHTML = html_string;

            let html_nodes = temp_node.childNodes;

            let formatted_html = '';
            let indentation = 0;

            // Each node should be on a new line and have an indentation of 4 spaces more than its parent node.
            function formatNode(node){
                let node_string = '';
                if(node.nodeType === 1){
                    node_string += ' '.repeat(indentation) + '<' + node.tagName.toLowerCase();
                    for(let i = 0; i < node.attributes.length; i++){
                        node_string += ` ${node.attributes[i].name}="${node.attributes[i].value}"`;
                    }
                    node_string += '>\n';
                    indentation += 4;
                    for(let i = 0; i < node.childNodes.length; i++){
                        node_string += formatNode(node.childNodes[i]);
                    }
                    indentation -= 4;
                    node_string += ' '.repeat(indentation) + `</${node.tagName.toLowerCase()}>\n`;
                }
                else if(node.nodeType === 3){
                    node_string += ' '.repeat(indentation) + node.textContent + '\n';
                }
                return node_string;
            }

            for(let i = 0; i < html_nodes.length; i++){
                formatted_html += formatNode(html_nodes[i]);
            }

            //Replace the < and > characters with their HTML entities to display them in the pre tag.
            formatted_html = formatted_html.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return formatted_html;
            
        }

        // Convert an XML string to a JSON object.
        function xmlToJson(xml) {
            var obj = {};
            if (xml.nodeType == 1) {
                if (xml.attributes.length > 0) {
                obj["@attributes"] = {};
                for (var j = 0; j < xml.attributes.length; j++) {
                    var attribute = xml.attributes.item(j);
                    obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
                }
                }
            } else if (xml.nodeType == 3) {
                obj = xml.nodeValue;
            }
            if (xml.hasChildNodes()) {
                for (var i = 0; i < xml.childNodes.length; i++) {
                var item = xml.childNodes.item(i);
                var nodeName = item.nodeName;
                if (typeof obj[nodeName] == "undefined") {
                    obj[nodeName] = xmlToJson(item);
                } else {
                    if (typeof obj[nodeName].push == "undefined") {
                    var old = obj[nodeName];
                    obj[nodeName] = [];
                    obj[nodeName].push(old);
                    }
                    obj[nodeName].push(xmlToJson(item));
                }
                }
            }
            return obj;
        };

        //Convert a JSON object to an XML string.
        function jsonToXml(json) {
            var xml = '';
            for (var prop in json) {
                if (json[prop] instanceof Array) {
                    for (var array in json[prop]) {
                        xml += "<" + prop + ">";
                        xml += jsonToXml(new Object(json[prop][array]));
                        xml += "</" + prop + ">";
                    }
                } else if (typeof json[prop] == 'object') {
                    xml += "<" + prop + ">";
                    xml += jsonToXml(new Object(json[prop]));
                    xml += "</" + prop + ">";
                } else {
                    xml += "<" + prop + ">" + json[prop] + "</" + prop + ">";
                }
            }
            return xml.replace("<#text>", "").replace("</#text>", "");
        }

        function submitMonitor(){

            toggleLoading(true);

            let data = null;

            if(document.getElementById('email').value == ''){
                alert('Please enter an email');
                toggleLoading(false);
                return;
            }

            if(FETCHED_TYPE === 'html'){
                data = {
                    url: FETCHED_URL,
                    type: FETCHED_TYPE,
                    steps: document.getElementById('selector-input').value,
                    email: document.getElementById('email').value,
                };
            }
            else{
                data = {
                    url: FETCHED_URL,
                    type: FETCHED_TYPE,
                    steps: STEPS,
                    email: document.getElementById('email').value,
                };
            }

            let cont = confirm(`Are you sure you want to monitor the following data?\n
                URL: ${data.url}\n
                Type: ${data.type}\n
                Key Steps: ${data.steps}\n
                Email: ${data.email}
            `)

            if(!cont){
                toggleLoading(false);
                return;
            }

            fetch(`http://127.0.0.1:5000/monitor`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                alert('Monitoring data.');
                toggleLoading(false);
                window.location.reload();
            })
            .catch(err => {
                console.error(err);
                alert('Error submitting data. Please try again.');
                toggleLoading(false);
            });
        }

        function toggleLoading(on){
            if(on){
                document.getElementById('loading-blind').style.display = 'flex';
            }
            else{
                document.getElementById('loading-blind').style.display = 'none';
            }
        }

        function toggleModal(modal_id, open = true){
            let modal = document.getElementById(modal_id);

            if (modal.style.display === 'flex' || modal.style.display === 'block' || !open) {
                modal.style.display = 'none';
            } else{
                modal.style.display = 'flex';
            }
        
        }

    </script>

</body>
</html>